<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title></title>

    <link href="lib/ionic/css/ionic.css" rel="stylesheet">

    <!-- IF using Sass (run gulp sass first), then uncomment below and remove the CSS includes above
    <link href="css/ionic.app.css" rel="stylesheet">
    -->

    <!-- ionic/angularjs js -->
    <script src="lib/ionic/js/ionic.bundle.js"></script>
    <script src="lib/pouchdb/dist/pouchdb.min.js"></script>

    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyA2u0eQNzCuDMdzG4opRM1ELacupQbzX28&sensor=true"></script>

    <!-- your app's js -->
    <!-- cordova script (this will be a 404 during development) -->
    <script src="js/infobubble.js"></script>
    <script src="tabs/map.js"></script>

    <script src="cordova.js"></script>

  </head>

  <style>
  #content {
  	line-height:1em;
  }

  #infoWindowTitle {
  	font-weight:bold;
  	font-size:1.2em;
  }
  #infoWindowOrgname {
  	color:rgb(117, 82, 82);
  }
  #infoWindowAddress{

  }
  #infoWindowDatetime  {

  }
  #infoWindowType{
		float:right;
  }
  #infoWindowDeadline {
        float:right;
  }


  </style>

	<body ng-app="starter">
    	<ion-content class="has-tabs">

			<div class="tabs tabs-icon-top">
			  <a class="tab-item" ui-sref="home" nav-transition="none">
				<i class="icon ion-map"></i>
				Map
			  </a>
			  <a class="tab-item" ui-sref="opportunities.posts" nav-transition="none">
				<i class="icon ion-ios-people"></i>    Opportunities

			  </a>
			  <a class="tab-item" ui-sref="care" nav-transition="none">
				<i class="icon ion-heart"></i>
				Care
			  </a>
			  <a class="tab-item" ui-sref="settings" nav-transition="none">
				<i class="icon ion-gear-a"></i>
				Settings
			  </a>
			  <a class="tab-item" ui-sref="search" nav-transition="none">
				<i class="icon ion-search"></i>
				Search
			  </a>
			</div>

			<ion-nav-view></ion-nav-view>

	        </ion-content>
    	<script>

var dbpostings = new PouchDB('postings');
var remoteCouch = "http://localhost:5984/postings";

var myMain = angular.module('starter', ['ionic']);

myMain.run(function($ionicPlatform) {
  $ionicPlatform.ready(function() {
    if(window.cordova && window.cordova.plugins.Keyboard) {
      // Hide the accessory bar by default (remove this to show the accessory bar above the keyboard
      // for form inputs)
      cordova.plugins.Keyboard.hideKeyboardAccessoryBar(true);

      // Don't remove this line unless you know what you are doing. It stops the viewport
      // from snapping when text inputs are focused. Ionic handles this internally for
      // a much nicer keyboard experience.
      cordova.plugins.Keyboard.disableScroll(true);
    }
    if(window.StatusBar) {
      StatusBar.styleDefault();
    }
  });
})
myMain.config(['$ionicConfigProvider', function($ionicConfigProvider) { //, $stateProvider, $urlRouterProvider
	$ionicConfigProvider.tabs.position('bottom'); // other values: top
}]);

myMain.config(function($stateProvider, $urlRouterProvider) {
    $stateProvider
        .state('home', {
            url: '/', //TO CHECK WHETHER THIS IS CORRECT
            templateUrl: 'tabs/map.html',
            controller: 'MapCtrl'
        })

        .state('opportunities', {
        	url: '/opportunities',
        	templateUrl: 'tabs/opportunities.html'
        })

        .state('opportunities.posts', {
        	url: '/posts',
        	templateUrl: 'tabs/opportunities.posts.html', //templateUrl: 'posts.html',
			resolve: {
			  posts: ['posts', function (posts) {
				return posts.all();
			  }]
			},
			controller: 'OpportunitiesController' //I NEED VALUES HERE THAT ARE MAYBE... FROM MY DATABASE,
													//TO BE DISPLAYED IN MY TEMPLATE
        })

        .state('care', {
        	url: '/care',
        	templateUrl: 'tabs/care.html'
        })

        .state('settings', {
        	url: '/settings',
        	templateUrl: 'tabs/settings.html'
        })

        .state('search', {
        	url: '/search',
        	templateUrl: 'tabs/search.html'
        })

        .state('opportunities.post-detail', {
            url: "/:postId", //represents a parameter that will be passed into our controller
            templateUrl: "post-detail.html",

            //on how to use resolve, https://github.com/angular-ui/ui-router/wiki#resolve
            resolve: {
                docdetail: function($stateParams) {
                    var doc = $stateParams.postId;

                    //maybe do a sync to pull data from remoteCouch to dbpostings here
                    function syncError() {
                        console.log('Unable to sync with remote');
                    }
                    function sync() {
                      var opts = {live: true};
                      dbpostings.sync(remoteCouch, opts, syncError);
                    }
                    if(remoteCouch) {
                      sync();
                    }


                    return dbpostings.get(doc).then(function (resp) {
                        //alert(resp.title);
                        return resp;
                    }).catch(function (err) {
                      console.log(err);
                    });
                }
            },

            //get the document that has the clicked id, and I want to display all details of only
            //that doc
            controller: function ($scope, docdetail) {
                $scope.docdetail = docdetail;
            }

        });

    $urlRouterProvider.otherwise('/');
});


myMain.factory('posts', ['$http', function($http) {
  var path = 'http://localhost:5984/postings/_all_docs?limit=20&include_docs=true';

  var posts = $http.get(path).then(function(response) {
      return response.data.rows;
  });

  var factory = {};

  factory.all = function() {
    return posts;
  };

  return factory;
}]);

myMain.controller("OpportunitiesController", ['$scope', 'posts', function($scope, posts) {

    $scope.posts = posts;

}]);





//UNABLE TO PLACE ALL MY MAPS CODE IN TABS/MAP.JS
function onload() {
	document.addEventListener("deviceready", onDeviceReady, false);
}

function onDeviceReady() {}

//FETCHING AND DISPLAYING MARKERS FROM MY DATABASE
myMain.factory('Markers', function ($http) {
  var markers = [];

  return {
    getMarkers: function(){
      return $http.get("http://localhost:5984/postings/_all_docs?limit=20&include_docs=true").then(function(response){
          markers = response.data.rows;
          return markers;
      });
    }
  }
});

myMain.controller('MapCtrl', function($scope, Markers) {

    google.maps.event.addDomListener(window, 'load', function() {

        var myLatlng = new google.maps.LatLng(37.3000, -120.4833);
        var mapOptions = {
            center: myLatlng,
            zoom: 15,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map = new google.maps.Map(document.getElementById("map"), mapOptions);
        $scope.map = map;

        //GET USER's LOCATION
        var onSuccess = function(position) {

			map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
			var myLocation = new google.maps.Marker({
				position: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
				map: map,
				title: "My Location"
			});

        };

        function onError(error) {
            alert('code: '    + error.code    + '\n' +
                  'message: ' + error.message + '\n');
        }

        var options = {maximumAge: 0, timeout: 10000, enableHighAccuracy:true};
        navigator.geolocation.getCurrentPosition(onSuccess, onError, options);

        google.maps.event.addListenerOnce($scope.map, 'idle', function(){
			//Load the markers
			loadMarkers();

        });


		function loadMarkers(){
			//Get all of the markers from our Markers factory
			Markers.getMarkers().then(function(markers){

				var records = markers;

				for (var i = 0; i < records.length; i++) {

					var record = records[i];
					var markerPos = new google.maps.LatLng(record.doc.lat, record.doc.lng);

					// Add the marker to the map
					var marker = new google.maps.Marker({
						map: map,
						animation: google.maps.Animation.DROP,
						position: markerPos
					});

					var infoBubbleContent = "<div id='content'><p id='infoWindowTitle'>" + record.doc.title +
						"</p><p id='infoWindowOrgname'>" + record.doc.orgname +
						"</p><p id='infoWindowDeadline'>" + record.doc.deadline +
						"</p><p id='infoWindowAddress'>" + record.doc.address +
						"</p><p id='infoWindowType'>" + record.doc.type +
						"</p><p id='infoWindowDatetime'>" + record.doc.datetime +
						"</p></div>";
					addInfoBubble(marker, infoBubbleContent, record);

/*
					var infoWindowContent = "<h4>" + record.doc.title + "</h4>";
					addInfoWindow(marker, infoWindowContent, record);
*/
				}
			});
		}

		function addInfoBubble(marker, message, record) {
			var infoBubble = new InfoBubble({
				minWidth: 250,
				maxWidth: 250,
				minHeight: 100,
				borderRadius: 0,
				borderWidth: 5,
				borderColor: 'rgb(84, 9, 9)',
				content: message
			});
			google.maps.event.addListener(marker, 'click', function() {
				infoBubble.open(map, marker);
			});
		}

/*
		function addInfoWindow(marker, message, record) {
		  var infoWindow = new google.maps.InfoWindow({
			  content: message
		  });
		  google.maps.event.addListener(marker, 'click', function () {
			  infoWindow.open(map, marker);
		  });
		}
*/
    });

});







    	</script>
    </body>
</html>

